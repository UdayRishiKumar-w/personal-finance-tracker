groups:
  - name: pft-api
    interval: 15s
    rules:
      # Request rate over 5 minutes
      - record: job:pft_backend:http_requests:rate5m
        expr: sum(rate(http_server_requests_seconds_count[5m]))

      # Error request rate over 5 minutes
      - record: job:pft_backend:http_requests_errors:rate5m
        expr: sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m]))

      # Error percentage (guarding against divide by zero)
      - record: job:pft_backend:http_requests_error_rate:percentage
        expr: |
          100 * job:pft_backend:http_requests_errors:rate5m
          / clamp_min(job:pft_backend:http_requests:rate5m, 1)

      # P95 latency for all HTTP requests
      - record: job:pft_backend:http_request_duration_seconds:p95
        expr: |
          histogram_quantile(
            0.95,
            sum(rate(http_server_requests_seconds_bucket[5m])) by (le)
          )

      # Alert: high error rate
      - alert: PFTBackendHighErrorRate
        expr: job:pft_backend:http_requests_error_rate:percentage > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate on PFT backend"
          description: "Error rate is {{ $value }}% over the last 5 minutes (threshold 5%)."

      # Alert: high latency
      - alert: PFTBackendHighLatencyP95
        expr: job:pft_backend:http_request_duration_seconds:p95 > 1.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High P95 latency on PFT backend"
          description: "P95 latency is {{ $value }}s over the last 5 minutes (threshold 1.5s)."

